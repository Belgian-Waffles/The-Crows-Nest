<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Forum</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm"
        crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
        crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
        crossorigin="anonymous"></script>
</head>

<body>
    <div>
        <h1>
            Forum
        </h1>
        <div class="forum">

        </div>
    </div>
    <form role="form">
        <p>
            Make a Post
        </p>
        <div class="form-group">
            <label for="thread">Thread Title</label>
            <input type="text" class="form-control" id="thread">
        </div>
        <div class="form-group">
            <label for="post">Post Title</label>
            <input type="text" class="form-control" id="post">
        </div>
        <div class="form-group">
            <label for="post-body">Post Body</label>
            <input type="text" class="form-control" id="post-body">
        </div>
        <button type="submit" class="btn btn-primary submit">Submit</button>
    </form>

    <div class="d-none" id="userNameHolder">{{username}}</div>
    <div class="d-none" id="userIdHolder">{{id}}</div>
</body>
{{!--
<script src="../../public/assets/js/forum.js" type="text/javascript"></script> --}}

<script type="text/javascript">
    $(document).ready(function () {
        var url = window.location.search;
        var communityID;
        var currentThread;
        var forumID;
        if (url.indexOf("?community_id=") !== -1) {
            communityID = url.split("=")[1];
        }
        else {
            communityID = 1;
        }
        setForum();
        $(document).on("click", ".thread", function (event) {
            event.preventDefault();
            currentThread = $(this);
            showThread();
        });
        $(document).on("click", ".submit", postToForum);
        function setForum() {
            $.get("/api/communities/" + communityID, function (data) {
                $(".forum").empty();
                var forum = data.Forum;
                forumID = forum.id;
                var forumThreads = [];
                $.get("/api/forums/" + forumID, function (data) {
                    forumThreads = data.Threads;
                    var rowsToAdd = [];
                    if (forumThreads.length > 0) {
                        for (i = 0; i < forumThreads.length; i++) {
                            var threadElement = $(
                                [
                                    "<li class='thread' id='" + forumThreads[i].id + "'",
                                    "<span>",
                                    forumThreads[i].title,
                                    "</span>",
                                    "</li>"
                                ].join(""));
                            threadElement.attr("threadID", forumThreads[i].id);
                            threadElement.attr("threadTitle", forumThreads[i].title);
                            rowsToAdd.push(threadElement);
                        }
                        $(".forum").prepend(rowsToAdd);
                    }
                    else {
                        throw new Error("fail set forum");
                    }
                });
            });
        };
        function showThread() {
            $(".forum").empty();
            if (currentThread) {
                $("#thread").val(currentThread.attr("threadTitle"));
                //$("#thread").data("thread-id", currentThread.id);
                var threadPosts;
                $.get("/api/threads/" + currentThread.attr("threadID"), function (data) {
                    threadPosts = data.Posts;
                    var rowsToAdd = [];
                    if (threadPosts.length > 0) {
                        for (i = 0; i < threadPosts.length; i++) {
                            var currentPost = threadPosts[i];
                            var tempStr = [
                                "<li class='post' id='" + currentPost.id + "'>",
                                "<span>",
                                currentPost.title,
                                "</span>",
                                "<p>",
                                currentPost.body,
                                "</p>",
                                "</li>"
                            ].join("");
                            var postElement = $(tempStr);
                            rowsToAdd.push(postElement);
                        }
                        $(".forum").prepend(rowsToAdd);
                    }
                    else {
                        throw new Error("fail show thread");
                    }
                });
            }
            else {
                throw new Error("Unable to load thread")
            }
        };
        function postToForum(event) {
            event.preventDefault();
            if (!currentThread) {
                if ($("#thread").val().trim() !== "" || $("#thread").val().trim() !== undefined || $("#thread").val().trim() !== null) {
                    var newThread = {
                        title: $("#thread").val().trim(),
                        ForumId: forumID,
                        UserId: parseInt($("#userIdHolder").text().trim())
                    }
                    console.log(newThread);
                    $.post("/api/threads", newThread)
                        .then(function (data) {
                            console.log(data);
                            postHandler(data.id);
                        });
                }
                else {
                    throw new Error("No thread title")
                }
            }
            else {
                postHandler(currentThread.attr("threadID"));
            }
        };
        function postHandler(theThreadId) {
            if ($("#post").val().trim() !== "" || $("#post").val().trim() !== undefined || $("#post").val().trim() !== null) {
                if ($("#post-body").val().trim() !== "" || $("#post-body").val().trim() !== undefined || $("#post-body").val().trim() !== null) {
                    var newPost = {
                        title: $("#post").val().trim(),
                        body: $("#post-body").val().trim(),
                        UserId: parseInt($("#userIdHolder").text().trim()),
                        ThreadId: theThreadId
                    }
                    $.post("/api/posts", newPost);
                }
            }
        }
    });
</script>

</html>